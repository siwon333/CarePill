{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="bg-white rounded p-4 shadow-sm mb-4">
            <h1 class="mb-3">
                <i class="fas fa-microscope text-primary me-2"></i>
                약물 인식 시스템
            </h1>
            <p class="lead text-muted">AI 기술로 약물을 정확하게 분석하고 식별합니다</p>
        </div>
        
        <div class="bg-white rounded p-4 shadow-sm mb-4">
            <h3 class="mb-4">분석 유형을 선택하세요</h3>
            <div class="row g-4">
                <!-- 약봉투 글씨 인식 -->
                <div class="col-md-4">
                    <div class="card analysis-card h-100" data-analysis-type="envelope">
                        <div class="card-body text-center">
                            <i class="fas fa-envelope fa-3x text-primary mb-3"></i>
                            <h5>약봉투 글씨 인식</h5>
                            <p class="text-muted small">약봉투의 처방전 정보를 읽어 약품명과 복용법을 추출합니다.</p>
                        </div>
                    </div>
                </div>
                
                <!-- 복용시간 인식 -->
                <div class="col-md-4">
                    <div class="card analysis-card h-100" data-analysis-type="schedule">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-3x text-success mb-3"></i>
                            <h5>복용시간 인식</h5>
                            <p class="text-muted small">아침, 점심, 저녁 복용 스케줄을 이미지에서 인식합니다.</p>
                        </div>
                    </div>
                </div>
                
                <!-- 약 외관 식별 -->
                <div class="col-md-4">
                    <div class="card analysis-card h-100" data-analysis-type="appearance">
                        <div class="card-body text-center">
                            <i class="fas fa-search fa-3x text-warning mb-3"></i>
                            <h5>약 외관 식별</h5>
                            <p class="text-muted small">약물의 모양과 색상으로 어떤 약인지 식별합니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 파일 업로드 폼 -->
        <div class="bg-white rounded p-4 shadow-sm">
            <form id="uploadForm" method="post" action="{% url 'upload_and_analyze' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="analysisType" name="analysis_type" value="">
                
                <div class="upload-zone" id="uploadZone">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h4>이미지를 선택하세요</h4>
                    <p class="text-muted">위의 분석 유형을 먼저 선택한 후 이미지를 업로드하세요</p>
                    <input type="file" id="imageInput" name="image" accept="image/*" class="form-control mt-3" disabled>
                </div>
                
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn" disabled>
                        <i class="fas fa-microscope me-2"></i>분석 시작
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="bg-white rounded p-4 shadow-sm">
            <h4 class="mb-4">
                <i class="fas fa-history text-primary me-2"></i>
                최근 분석 결과
            </h4>
            {% for analysis in recent_analyses %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            {% if analysis.analysis_type == 'envelope' %}
                                <i class="fas fa-envelope text-primary me-2"></i>
                            {% elif analysis.analysis_type == 'schedule' %}
                                <i class="fas fa-clock text-success me-2"></i>
                            {% else %}
                                <i class="fas fa-search text-warning me-2"></i>
                            {% endif %}
                            <h6 class="card-title mb-0">{{ analysis.get_analysis_type_display }}</h6>
                        </div>
                        <p class="card-text text-muted small mb-2">
                            <i class="fas fa-calendar me-1"></i>
                            {{ analysis.created_at|date:"m월 d일 H:i" }}
                        </p>
                        <a href="{% url 'analysis_detail' analysis.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>결과 보기
                        </a>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-4">
                    <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                    <p class="text-muted">아직 분석 결과가 없습니다.</p>
                    <small class="text-muted">첫 번째 분석을 시작해보세요!</small>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analysisCards = document.querySelectorAll('.analysis-card');
    const analysisTypeInput = document.getElementById('analysisType');
    const imageInput = document.getElementById('imageInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const uploadZone = document.getElementById('uploadZone');
    
    analysisCards.forEach(card => {
        card.addEventListener('click', function() {
            // 모든 카드의 선택 상태 제거
            analysisCards.forEach(c => {
                c.classList.remove('border-primary', 'bg-light');
                c.style.backgroundColor = '';
            });
            
            // 클릭된 카드 선택 표시
            this.classList.add('border-primary');
            this.style.backgroundColor = '#e3f2fd';
            
            // 분석 타입 설정
            const analysisType = this.dataset.analysisType;
            analysisTypeInput.value = analysisType;
            
            // 이미지 입력 활성화
            imageInput.disabled = false;
            uploadZone.style.borderColor = '#28a745';
            
            // 안내 메시지 업데이트
            const uploadTitle = uploadZone.querySelector('h4');
            uploadTitle.textContent = '이미지를 업로드하세요';
        });
    });
    
    imageInput.addEventListener('change', function() {
        if (this.files.length > 0 && analysisTypeInput.value) {
            analyzeBtn.disabled = false;
            analyzeBtn.classList.add('btn-success');
            analyzeBtn.classList.remove('btn-primary');
            
            // 파일명 표시
            const fileName = this.files[0].name;
            const uploadTitle = uploadZone.querySelector('h4');
            uploadTitle.innerHTML = `<i class="fas fa-check text-success me-2"></i>선택된 파일: ${fileName}`;
        }
    });
});
</script>
{% endblock %}