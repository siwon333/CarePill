<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STT ì§„ë‹¨ ë„êµ¬</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
    button {
      background: #4CAF50;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #fafafa;
      border-radius: 5px;
    }
    .section h2 {
      margin-top: 0;
      color: #555;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ¤ STT ì§„ë‹¨ ë„êµ¬ (ë¼ì¦ˆë² ë¦¬íŒŒì´ ì „ìš©)</h1>

  <div class="section">
    <h2>1ï¸âƒ£ í™˜ê²½ í™•ì¸</h2>
    <div id="envCheck"></div>
  </div>

  <div class="section">
    <h2>2ï¸âƒ£ ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸</h2>
    <div id="browserCheck"></div>
  </div>

  <div class="section">
    <h2>3ï¸âƒ£ ë³´ì•ˆ í”„ë¡œí† ì½œ í™•ì¸</h2>
    <div id="securityCheck"></div>
  </div>

  <div class="section">
    <h2>4ï¸âƒ£ ë§ˆì´í¬ ê¶Œí•œ í™•ì¸</h2>
    <button id="checkMic">ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­</button>
    <div id="micCheck"></div>
  </div>

  <div class="section">
    <h2>5ï¸âƒ£ STT í…ŒìŠ¤íŠ¸</h2>
    <button id="startTest" disabled>ìŒì„± ì¸ì‹ ì‹œì‘</button>
    <button id="stopTest" disabled>ìŒì„± ì¸ì‹ ì¢…ë£Œ</button>
    <div id="sttResult"></div>
    <div class="log" id="sttLog"></div>
  </div>

  <div class="section">
    <h2>ğŸ“‹ í•´ê²° ë°©ë²•</h2>
    <div id="solutions"></div>
  </div>
</div>

<script>
let recognition = null;

// ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
function log(message, type = 'info') {
  const logDiv = document.getElementById('sttLog');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  const timestamp = new Date().toLocaleTimeString();
  entry.textContent = `[${timestamp}] ${message}`;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
  console.log(message);
}

// 1. í™˜ê²½ í™•ì¸
function checkEnvironment() {
  const envDiv = document.getElementById('envCheck');
  let html = '';

  html += `<div class="status info">
    <strong>URL:</strong> ${window.location.href}<br>
    <strong>í”„ë¡œí† ì½œ:</strong> ${window.location.protocol}<br>
    <strong>í˜¸ìŠ¤íŠ¸:</strong> ${window.location.hostname}<br>
    <strong>User Agent:</strong> ${navigator.userAgent}
  </div>`;

  // Chromium ë²„ì „ í™•ì¸
  const chromiumMatch = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);
  if (chromiumMatch) {
    html += `<div class="status success">
      âœ… Chromium ë²„ì „: ${chromiumMatch[2]}
    </div>`;
  } else {
    html += `<div class="status error">
      âŒ Chromiumì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
    </div>`;
  }

  envDiv.innerHTML = html;
}

// 2. ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
function checkBrowserSupport() {
  const browserDiv = document.getElementById('browserCheck');
  let html = '';

  if ('webkitSpeechRecognition' in window) {
    html += `<div class="status success">
      âœ… webkitSpeechRecognition ì§€ì›ë¨
    </div>`;
  } else if ('SpeechRecognition' in window) {
    html += `<div class="status success">
      âœ… SpeechRecognition ì§€ì›ë¨
    </div>`;
  } else {
    html += `<div class="status error">
      âŒ Web Speech APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤<br>
      â†’ Chromium ë²„ì „ì„ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
    </div>`;
  }

  // MediaDevices API í™•ì¸
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    html += `<div class="status success">
      âœ… MediaDevices API ì§€ì›ë¨
    </div>`;
  } else {
    html += `<div class="status error">
      âŒ MediaDevices APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
    </div>`;
  }

  browserDiv.innerHTML = html;
}

// 3. ë³´ì•ˆ í”„ë¡œí† ì½œ í™•ì¸
function checkSecurity() {
  const securityDiv = document.getElementById('securityCheck');
  let html = '';

  const isSecure = window.location.protocol === 'https:';
  const isLocalhost = window.location.hostname === 'localhost' ||
                      window.location.hostname === '127.0.0.1' ||
                      window.location.hostname === '[::1]';

  if (isSecure) {
    html += `<div class="status success">
      âœ… HTTPS ì—°ê²° - ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ ì¶©ì¡±
    </div>`;
  } else if (isLocalhost) {
    html += `<div class="status success">
      âœ… localhost ì—°ê²° - ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ ì¶©ì¡±
    </div>`;
  } else {
    html += `<div class="status error">
      âŒ HTTP ì—°ê²° - Web Speech APIëŠ” HTTPS ë˜ëŠ” localhostì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤<br>
      <strong>í˜„ì¬ í”„ë¡œí† ì½œ:</strong> ${window.location.protocol}
    </div>`;
  }

  // ì¸í„°ë„· ì—°ê²° í™•ì¸
  if (navigator.onLine) {
    html += `<div class="status success">
      âœ… ì¸í„°ë„· ì—°ê²°ë¨
    </div>`;
  } else {
    html += `<div class="status error">
      âŒ ì¸í„°ë„· ì—°ê²° ì•ˆ ë¨ - Google STT ì„œë²„ ì ‘ì† ë¶ˆê°€
    </div>`;
  }

  securityDiv.innerHTML = html;
}

// 4. ë§ˆì´í¬ ê¶Œí•œ í™•ì¸
document.getElementById('checkMic').addEventListener('click', async () => {
  const micDiv = document.getElementById('micCheck');
  micDiv.innerHTML = '<div class="status info">â³ ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•˜ëŠ” ì¤‘...</div>';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    micDiv.innerHTML = '<div class="status success">âœ… ë§ˆì´í¬ ê¶Œí•œ í—ˆìš©ë¨</div>';

    // ì˜¤ë””ì˜¤ íŠ¸ë™ ì •ë³´ í‘œì‹œ
    const audioTracks = stream.getAudioTracks();
    if (audioTracks.length > 0) {
      micDiv.innerHTML += `<div class="status info">
        <strong>ë§ˆì´í¬:</strong> ${audioTracks[0].label}
      </div>`;
    }

    // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
    stream.getTracks().forEach(track => track.stop());

    // STT í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í™œì„±í™”
    document.getElementById('startTest').disabled = false;
    log('ë§ˆì´í¬ ê¶Œí•œ í—ˆìš©ë¨', 'success');
  } catch (error) {
    micDiv.innerHTML = `<div class="status error">
      âŒ ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ë¨<br>
      <strong>ì—ëŸ¬:</strong> ${error.message}<br>
      <strong>í•´ê²°:</strong> ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”
    </div>`;
    log(`ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜: ${error.message}`, 'error');
  }
});

// 5. STT í…ŒìŠ¤íŠ¸
document.getElementById('startTest').addEventListener('click', () => {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();

  recognition.lang = 'ko-KR';
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.maxAlternatives = 3;

  recognition.onstart = () => {
    log('ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘ë¨', 'success');
    document.getElementById('sttResult').innerHTML =
      '<div class="status success">ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë§ì”€í•´ì£¼ì„¸ìš”</div>';
    document.getElementById('startTest').disabled = true;
    document.getElementById('stopTest').disabled = false;
  };

  recognition.onresult = (event) => {
    const last = event.results.length - 1;
    const result = event.results[last];
    const transcript = result[0].transcript;
    const confidence = result[0].confidence;
    const isFinal = result.isFinal;

    log(`${isFinal ? 'âœ… ìµœì¢…' : 'â³ ì„ì‹œ'}: "${transcript}" (ì‹ ë¢°ë„: ${(confidence * 100).toFixed(1)}%)`);

    if (isFinal) {
      document.getElementById('sttResult').innerHTML = `
        <div class="status success">
          <strong>ì¸ì‹ëœ í…ìŠ¤íŠ¸:</strong> ${transcript}<br>
          <strong>ì‹ ë¢°ë„:</strong> ${(confidence * 100).toFixed(1)}%
        </div>`;
    } else {
      document.getElementById('sttResult').innerHTML = `
        <div class="status info">
          <strong>ì‹¤ì‹œê°„:</strong> ${transcript}
        </div>`;
    }
  };

  recognition.onerror = (event) => {
    log(`âŒ ì˜¤ë¥˜: ${event.error}`, 'error');
    document.getElementById('sttResult').innerHTML = `
      <div class="status error">
        âŒ ì˜¤ë¥˜ ë°œìƒ: ${event.error}<br>
        ${getErrorHelp(event.error)}
      </div>`;
    document.getElementById('startTest').disabled = false;
    document.getElementById('stopTest').disabled = true;
  };

  recognition.onend = () => {
    log('ìŒì„± ì¸ì‹ ì¢…ë£Œë¨', 'info');
    document.getElementById('startTest').disabled = false;
    document.getElementById('stopTest').disabled = true;
  };

  try {
    recognition.start();
  } catch (error) {
    log(`ì‹œì‘ ì‹¤íŒ¨: ${error.message}`, 'error');
    alert(`ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨: ${error.message}`);
  }
});

document.getElementById('stopTest').addEventListener('click', () => {
  if (recognition) {
    recognition.stop();
  }
});

// ì˜¤ë¥˜ë³„ ë„ì›€ë§
function getErrorHelp(error) {
  const helpMap = {
    'not-allowed': 'ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”.',
    'no-speech': 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆì´í¬ê°€ ì œëŒ€ë¡œ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.',
    'audio-capture': 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.',
    'network': 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.',
    'service-not-allowed': 'HTTPS ë˜ëŠ” localhostì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.',
    'aborted': 'ìŒì„± ì¸ì‹ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'
  };
  return helpMap[error] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ì…ë‹ˆë‹¤.';
}

// í•´ê²° ë°©ë²• í‘œì‹œ
function showSolutions() {
  const solutionsDiv = document.getElementById('solutions');
  const isSecure = window.location.protocol === 'https:';
  const isLocalhost = window.location.hostname === 'localhost' ||
                      window.location.hostname === '127.0.0.1';

  let solutions = '';

  if (!isSecure && !isLocalhost) {
    solutions += `
      <div class="status error">
        <h3>âŒ HTTPS ë¬¸ì œ í•´ê²° ë°©ë²•</h3>
        <ol>
          <li><strong>Djangoì—ì„œ HTTPS í™œì„±í™”:</strong>
            <pre style="background:#f4f4f4; padding:10px; border-radius:5px;">
# settings.pyì— ì¶”ê°€
SECURE_SSL_REDIRECT = False  # ê°œë°œ ì¤‘ì—ëŠ” False
SESSION_COOKIE_SECURE = False
CSRF_COOKIE_SECURE = False

# ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ ì‹¤í–‰
python manage.py runserver 0.0.0.0:8000</pre>
          </li>
          <li><strong>ngrok ì‚¬ìš© (ê°€ì¥ ì‰¬ì›€):</strong>
            <pre style="background:#f4f4f4; padding:10px; border-radius:5px;">
# ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ
./ngrok http 8000</pre>
          </li>
          <li><strong>ìì²´ ì„œëª… ì¸ì¦ì„œ ìƒì„±:</strong>
            <pre style="background:#f4f4f4; padding:10px; border-radius:5px;">
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
python manage.py runserver_plus --cert-file cert.pem --key-file key.pem 0.0.0.0:8000</pre>
          </li>
        </ol>
      </div>`;
  }

  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    solutions += `
      <div class="status error">
        <h3>âŒ Chromium ì—…ë°ì´íŠ¸ í•„ìš”</h3>
        <pre style="background:#f4f4f4; padding:10px; border-radius:5px;">
# ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ
sudo apt update
sudo apt install chromium-browser
chromium-browser --version</pre>
      </div>`;
  }

  if (!navigator.onLine) {
    solutions += `
      <div class="status error">
        <h3>âŒ ì¸í„°ë„· ì—°ê²° í™•ì¸</h3>
        <p>Web Speech APIëŠ” Google ì„œë²„ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì¸í„°ë„· ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
      </div>`;
  }

  if (solutions === '') {
    solutions = '<div class="status success">âœ… ëª¨ë“  ìš”êµ¬ì‚¬í•­ì´ ì¶©ì¡±ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
  }

  solutionsDiv.innerHTML = solutions;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ì²´í¬ ì‹¤í–‰
window.addEventListener('DOMContentLoaded', () => {
  checkEnvironment();
  checkBrowserSupport();
  checkSecurity();
  showSolutions();
});
</script>
</body>
</html>
