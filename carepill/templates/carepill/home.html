{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CarePill - í™ˆ</title>
  <link rel="stylesheet" href="{% static 'carepill/css/home.css' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Alkatra:wght@400..700&family=Baloo+Bhaijaan+2:wght@400..800&family=Jua&family=Luckiest+Guy&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
</head>
<body>
<div class="home-container">
  <div class="home-wrapper">
  <svg class="home-svg" viewBox="0 0 261 156" preserveAspectRatio="xMidYMid meet">
    <!-- Background -->
    <defs>
      <linearGradient id="bgGradient" x1="158.58" y1="43.5349" x2="88.9886" y2="176.434" gradientUnits="userSpaceOnUse">
        <stop offset="0" stop-color="white" />
        <stop offset="1" stop-color="#B8E6FF" />
      </linearGradient>

      <!-- Brand blob gradients -->
      <linearGradient id="brandGradient1" x1="58" y1="0" x2="58" y2="109.744" gradientUnits="userSpaceOnUse">
        <stop offset="0" stop-color="#FFCF41" />
        <stop offset="0.480769" stop-color="#FFB01F" />
      </linearGradient>

      <linearGradient id="brandGradient4" x1="58" y1="0" x2="58" y2="109.744" gradientUnits="userSpaceOnUse">
        <stop offset="0.0961538" stop-color="#FFCF41" />
        <stop offset="0.966346" stop-color="#FF9500" />
      </linearGradient>

      <!-- Button gradients -->
      <linearGradient id="orangeGradient" x1="58.7707" y1="0" x2="59.0525" y2="26.6532" gradientUnits="userSpaceOnUse">
        <stop offset="0" stop-color="#FFBD67" />
        <stop offset="1" stop-color="#FF7700" />
      </linearGradient>

      <linearGradient id="blueGradient" x1="59.1991" y1="3.91944" x2="59.1991" y2="33.7072" gradientUnits="userSpaceOnUse">
        <stop offset="0" stop-color="#75ABFF" />
        <stop offset="1" stop-color="#0063FF" />
      </linearGradient>

      <linearGradient id="purpleGradient" x1="59.0947" y1="0" x2="58.9783" y2="26.6525" gradientUnits="userSpaceOnUse">
        <stop offset="0" stop-color="#ED8EFF" />
        <stop offset="1" stop-color="#E100FF" />
      </linearGradient>

      <linearGradient id="greenGradient" x1="0" y1="0" x2="100" y2="0" gradientUnits="userSpaceOnUse">
        <stop offset="0" stop-color="#7FD896" />
        <stop offset="1" stop-color="#4CAF50" />
      </linearGradient>

      <!-- Filters -->
      <filter id="innerShadow" x="0" y="0" width="116" height="113.903" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
        <feFlood flood-opacity="0" result="BackgroundImageFix" />
        <feBlend in="SourceGraphic" in2="BackgroundImageFix" mode="normal" result="shape" />
        <feColorMatrix in="SourceAlpha" result="hardAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
        <feOffset dy="4" />
        <feGaussianBlur stdDeviation="4.15" />
        <feComposite in2="hardAlpha" k2="-1" k3="1" operator="arithmetic" />
        <feColorMatrix type="matrix" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.5 0" />
        <feBlend in2="shape" mode="normal" result="effect1_innerShadow" />
      </filter>

      <!-- Clip paths for pill right halves -->
      <clipPath id="pill1-right">
        <rect x="146" y="5.44" width="18" height="7.26" />
      </clipPath>
      <clipPath id="pill2-right">
        <rect x="189" y="5.44" width="18" height="7.26" />
      </clipPath>
      <clipPath id="pill3-right">
        <rect x="233" y="5.44" width="18" height="7.26" />
      </clipPath>
    </defs>

    <!-- Background rectangle -->
    <path d="M0 10C0 4.47716 4.47715 0 10 0H251C256.523 0 261 4.47715 261 10V146C261 151.523 256.523 156 251 156H10C4.47715 156 0 151.523 0 146V10Z" fill="url(#bgGradient)" />


    <a href="/scan/">
      <rect x="128" y="5.44" width="36" height="7.26" rx="3.63" fill="#FFD39E" />
      <rect x="128" y="5.44" width="36" height="7.26" rx="3.63" fill="#FFBD67" clip-path="url(#pill1-right)" />
      <line x1="146" y1="5.44" x2="146" y2="12.7" stroke="#FFE8C8" stroke-width="0.8" />
    </a>

    <a href="/voice_setup/">
      <rect x="171" y="5.44" width="36" height="7.26" rx="3.63" fill="#A5C9FF" />
      <rect x="171" y="5.44" width="36" height="7.26" rx="3.63" fill="#8FB8FF" clip-path="url(#pill2-right)" />
      <line x1="189" y1="5.44" x2="189" y2="12.7" stroke="#C8DEFF" stroke-width="0.8" />
    </a>

    <a href="/home/">
      <rect x="215" y="5.44" width="36" height="7.26" rx="3.63" fill="#F3B8FF" />
      <rect x="215" y="5.44" width="36" height="7.26" rx="3.63" fill="#EDA3FF" clip-path="url(#pill3-right)" />
      <line x1="233" y1="5.44" x2="233" y2="12.7" stroke="#F8D6FF" stroke-width="0.8" />
    </a>


  <!-- Brand blob (absolute positioned) -->
  <div class="brand-blob-container">
    <svg viewBox="0 0 116 110" fill="none" class="brand-blob-svg">
      <g filter="url(#innerShadow)">
        <path d="M86.7207 52.7973C86.7207 66.1295 75.3633 76.9373 61.3531 76.9373C47.343 76.9373 35.9855 66.1295 35.9855 52.7973C35.9855 39.4652 47.343 28.6574 61.3531 28.6574C75.3633 28.6574 86.7207 39.4652 86.7207 52.7973Z" fill="url(#brandGradient1)" />
        <path d="M13.4365 21.968C13.4365 16.4452 17.9136 11.968 23.4365 11.968H51.6663C57.1891 11.968 61.6663 16.4452 61.6663 21.968V66.9373C61.6663 72.4601 57.1891 76.9373 51.6663 76.9373H23.4365C17.9136 76.9373 13.4365 72.4602 13.4365 66.9373V21.968Z" fill="url(#brandGradient1)" />
        <path d="M87.6049 11.968C91.2366 11.968 94.7398 13.8991 95.7443 17.3891C96.3949 19.6492 96.7425 22.0284 96.7425 24.485C96.7425 39.2985 84.1231 51.3072 68.5563 51.3072C52.9894 51.3072 40.37 39.2985 40.37 24.485C40.37 22.0284 40.7177 19.6492 41.3682 17.3891C42.3728 13.8991 45.8759 11.968 49.5076 11.968H87.6049Z" fill="url(#brandGradient1)" />
        <path fill-rule="evenodd" clip-rule="evenodd" d="M104.604 0C105.625 0 106.636 0.299612 107.407 0.96923C108.55 1.9624 109.311 2.91225 109.669 3.37936C110.456 4.406 111.026 5.39079 111.38 6.04412C112.152 7.46625 112.85 9.08508 113.445 10.7625C114.644 14.146 115.756 18.7027 115.966 23.9135C116.276 31.627 114.545 41.0153 108.223 49.5805C106.636 51.73 105.717 54.3138 105.603 56.9829C105.41 61.5308 104.464 66.4227 102.327 71.2463C97.281 82.6366 86.5254 91.4988 69.7935 94.5304L12.1298 107.1C5.89532 108.459 0 103.71 0 97.3295V10C0 4.47715 4.47715 0 10 0H104.604ZM29.1123 60.2928C29.1123 66.6736 35.0075 71.4223 41.242 70.0634L63.0735 65.3049L63.4077 65.2314L63.7453 65.173C67.7753 64.4699 69.9704 63.3089 71.1424 62.4448C72.2859 61.6017 72.9786 60.659 73.45 59.5947C74.5716 57.0628 74.4532 53.6443 73.7982 51.4685L72.8823 48.4262C71.6548 44.3486 73.1441 39.941 76.5934 37.4437L79.3897 35.419C83.877 32.1701 79.8354 26.9281 74.2955 26.9281H39.1123C33.5895 26.9281 29.1123 31.4052 29.1123 36.9281V60.2928Z" fill="url(#brandGradient4)" />
        <path d="M16.9619 106.059L0 109.903V98.8476L14.0938 95.6533L16.9619 106.059Z" fill="#FF9E02" />
      </g>
    </svg>

    <p class="brand-subtitle">ë‹¹ì‹ ì˜ ë³µì•½ì„ ë” ì‰½ê³ ã€ì•ˆì „í•˜ê²Œ</p>
    <h1 class="brand-title">CARE<br>PILL</h1>

    <!-- Voice registration button -->
    <a href="{% url 'voice' %}" class="voice-register-btn">
      <svg viewBox="0 0 100 30" class="voice-btn-svg" preserveAspectRatio="none">
        <rect x="0" y="0" width="100" height="30" rx="15" fill="url(#greenGradient)" opacity="0.9" />
      </svg>
      <svg class="voice-btn-icon" viewBox="0 0 24 24" fill="none">
        <path d="M12 14C13.66 14 15 12.66 15 11V5C15 3.34 13.66 2 12 2C10.34 2 9 3.34 9 5V11C9 12.66 10.34 14 12 14Z" fill="white"/>
        <path d="M17 11C17 14.31 14.31 17 11 17C7.69 17 5 14.31 5 11H3C3 14.97 6.03 18.19 10 18.92V22H14V18.92C17.97 18.19 21 14.97 21 11H17Z" fill="white" transform="translate(1 0)"/>
      </svg>
      <span class="voice-btn-text">ë§í•˜ê¸°</span>
    </a>
  </div>

  <!-- ìˆ¨ê²¨ì§„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨ ì‘ê²Œ) -->
  <button id="testNotificationBtn" class="hidden-test-btn" onclick="testNotification()" title="ì•Œë¦¼ í…ŒìŠ¤íŠ¸">
    ğŸ””
  </button>

  <!-- ìŒì„± ì¬ìƒ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
  <button id="testAudioBtn" class="hidden-test-btn" onclick="testAudioPlay()" title="ìŒì„± ì¬ìƒ í…ŒìŠ¤íŠ¸" style="bottom: 100px;">
    ğŸ”Š
  </button>

  <!-- ì•½ ë³µìš© ì•Œë¦¼ ì˜¤ë²„ë ˆì´ -->
  <div id="medicationAlert" class="medication-alert-overlay" style="display: none;">
    <div class="medication-alert-card">
      <div class="alert-icon-container">
        <div class="alert-icon-pulse"></div>
        <span class="alert-icon">ğŸ’Š</span>
      </div>
      <h2 class="alert-title" id="alertTitle">ì•½ ë³µìš© ì‹œê°„ì…ë‹ˆë‹¤</h2>
      <p class="alert-message" id="alertMessage">íƒ€ì´ë ˆë†€ 500, ê°€ìŠ¤í„° 10mgë¥¼ ë³µìš©í•´ì£¼ì„¸ìš”.</p>
      <div class="alert-buttons">
        <button class="alert-btn alert-btn-primary" onclick="confirmMedication()">
          <span>í™•ì¸í–ˆì–´ìš”</span>
        </button>
        <button class="alert-btn alert-btn-secondary" onclick="snoozeMedication()">
          <span>10ë¶„ í›„ ì•Œë¦¼</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Buttons -->
  <div class="button-container">
    <!-- Mini tabs -->
    <div class="mini-tabs">
      <span class="mini-tab-text">ì•½ ë´‰íˆ¬ ìŠ¤ìº”</span>
      <span class="mini-tab-text">ìŒì„± ë“±ë¡</span>
      <span class="mini-tab-text" id="settingsTab" style="cursor: pointer;">ì„¤ì •</span>
    </div>

    <!-- Voice Recognition Status Overlay -->
    <div id="voiceStatusOverlay" class="voice-status-overlay" style="display: none;">
      <div class="voice-status-card">
        <button class="voice-close-btn" onclick="stopVoiceRecognition()">âœ•</button>
        <div class="voice-status-icon" id="voiceStatusIcon">
          <div class="voice-pulse"></div>
          <span class="voice-mic-icon">ğŸ¤</span>
        </div>
        <h2 class="voice-status-title" id="voiceStatusTitle">ìŒì„± ì¸ì‹ ì¤‘...</h2>
        <p class="voice-status-message" id="voiceStatusMessage">ëª…ë ¹ì–´ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”</p>
        <div class="voice-commands-help">
          <p><strong>ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:</strong></p>
          <ul>
            <li>"ì•½íˆ¬ì…" - ì•½ íˆ¬ì… í™”ë©´</li>
            <li>"í˜„ì¬ìˆëŠ” ì•½" - ì•½ ëª©ë¡ í™”ë©´</li>
            <li>"ë§í•˜ê¸°" - ìŒì„± ëŒ€í™” í™”ë©´</li>
            <li>"ì•½ë¶„ì¶œ" - ì•½ ë¶„ì¶œ í™”ë©´</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Orange button -->
    <a href="/scan_choice/" class="menu-button menu-button-1">
      <svg viewBox="0 0 118 27" class="button-svg" preserveAspectRatio="none">
        <g opacity="0.8">
          <path d="M117 0C117.338 9.25243e-08 117.671 0.017146 118 0.0498047V26.6016C117.671 26.6342 117.338 26.6523 117 26.6523H10C4.47722 26.6523 9.91628e-05 22.1751 0 16.6523V10C0 4.47715 4.47715 0 10 0H117Z" fill="url(#orangeGradient)" />
        </g>
      </svg>
      <img src="{% static 'carepill/images/pill.png' %}" class="button-icon" alt="">
      <span class="button-text">ì•½ íˆ¬ì…</span>
    </a>

    <!-- Blue button -->
    <a href="/meds/" class="menu-button menu-button-2">
      <svg viewBox="0 0 118 27" class="button-svg" preserveAspectRatio="none">
        <g opacity="0.8">
          <path d="M117 0C117.337 9.2524e-08 117.671 0.0161727 118 0.0488281V26.6006C117.671 26.6333 117.338 26.6514 117 26.6514H10C4.47715 26.6514 0 22.1742 0 16.6514V10C0 4.47715 4.47715 0 10 0H117Z" fill="url(#blueGradient)" />
        </g>
      </svg>
      <img src="{% static 'carepill/images/box.png' %}" class="button-icon" alt="">
      <span class="button-text">í˜„ì¬ìˆëŠ” ì•½</span>
    </a>

    <!-- Purple button -->
    <a href="/how2green/" class="menu-button menu-button-3">
      <svg viewBox="0 0 118 27" class="button-svg" preserveAspectRatio="none">
        <g opacity="0.8">
          <path d="M117 0C117.338 9.25238e-08 117.671 0.0171462 118 0.0498047V26.6016C117.671 26.6342 117.338 26.6523 117 26.6523H10C4.47721 26.6523 8.70927e-05 22.1751 0 16.6523V10C1.33034e-05 4.47716 4.47716 0 10 0H117Z" fill="url(#purpleGradient)" />
        </g>
      </svg>
      <img src="{% static 'carepill/images/chat.png' %}" class="button-icon" alt="">
      <span class="button-text">ì•½ ë¶„ì¶œ</span>
    </a>
  </div>
  </div>
</div>

<script src="{% static 'carepill/js/tts_helper.js' %}"></script>
<script src="{% static 'carepill/js/notification.js' %}"></script>

<script>
/**
 * ì•½ ë°°ì¶œ ì•Œë¦¼ ê¸°ëŠ¥ (INLINE - HOME PAGE)
 */
console.log('[HOME INLINE] MedicineDispenser ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');

class MedicineDispenser {
  constructor() {
    this.overlay = null;
    this.currentAudio = null;
  }

  async showDispenseNotification(medicineName, message, audioFiles) {
    console.log('[MedicineDispenser] ì•Œë¦¼ í‘œì‹œ ì‹œì‘:', { medicineName, message, audioFiles });

    this.hideNotification();

    this.overlay = document.createElement('div');
    this.overlay.className = 'dispense-notification';
    this.overlay.innerHTML = `
      <div class="dispense-card">
        <div class="dispense-icon">ğŸ’Š</div>
        <div class="dispense-message">${message}</div>
      </div>
    `;

    this.addStyles();
    document.body.appendChild(this.overlay);

    setTimeout(() => {
      this.overlay.classList.add('show');
    }, 10);

    // audioFilesê°€ ë°°ì—´ì´ë©´ ìˆœì°¨ ì¬ìƒ, ì•„ë‹ˆë©´ ë‹¨ì¼ ì¬ìƒ
    if (Array.isArray(audioFiles)) {
      this.playAudioSequence(audioFiles);
    } else {
      this.playAudio(audioFiles);
    }

    // 20ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«ê¸° (ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¼)
    setTimeout(() => {
      this.hideNotification(false); // false = ì˜¤ë””ì˜¤ëŠ” ë©ˆì¶”ì§€ ì•ŠìŒ
    }, 20000);
  }

  playAudioSequence(fileNames) {
    console.log('[MedicineDispenser] ìˆœì°¨ ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘:', fileNames);

    if (!Array.isArray(fileNames) || fileNames.length === 0) {
      return;
    }

    let currentIndex = 0;

    const playNext = () => {
      if (currentIndex >= fileNames.length) {
        console.log('[MedicineDispenser] ëª¨ë“  ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ');
        return;
      }

      const fileName = fileNames[currentIndex];
      console.log(`[MedicineDispenser] ${currentIndex + 1}/${fileNames.length} ì¬ìƒ ì¤‘: ${fileName}`);

      this.playAudioWithCallback(fileName, () => {
        currentIndex++;
        playNext();
      });
    };

    playNext();
  }

  playAudioWithCallback(fileName, onEndedCallback) {
    if (this.currentAudio) {
      this.currentAudio.pause();
      this.currentAudio.currentTime = 0;
      this.currentAudio = null;
    }

    try {
      const audioPath = `/static/carepill/audio/${fileName}`;
      console.log('[MedicineDispenser] ì˜¤ë””ì˜¤ ê²½ë¡œ:', audioPath);

      this.currentAudio = new Audio(audioPath);

      this.currentAudio.onended = () => {
        console.log('[MedicineDispenser] ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ');
        this.currentAudio = null;
        if (onEndedCallback) {
          onEndedCallback();
        }
      };

      this.currentAudio.onerror = (error) => {
        console.error('[MedicineDispenser] ìŒì„± ì¬ìƒ ì˜¤ë¥˜:', error);
        this.currentAudio = null;
        if (onEndedCallback) {
          onEndedCallback();
        }
      };

      this.currentAudio.play()
        .then(() => {
          console.log('[MedicineDispenser] âœ… ì˜¤ë””ì˜¤ ì¬ìƒ ì„±ê³µ!');
        })
        .catch(err => {
          console.error('[MedicineDispenser] âŒ ìŒì„± ì¬ìƒ ì‹¤íŒ¨:', err.name, err.message);
          if (onEndedCallback) {
            onEndedCallback();
          }
        });

    } catch (err) {
      console.error('[MedicineDispenser] ìŒì„± íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜:', err);
      if (onEndedCallback) {
        onEndedCallback();
      }
    }
  }

  playAudio(fileName) {
    this.playAudioWithCallback(fileName, null);
  }

  hideNotification(stopAudio = true) {
    if (this.overlay) {
      this.overlay.classList.remove('show');
      setTimeout(() => {
        if (this.overlay && this.overlay.parentNode) {
          this.overlay.parentNode.removeChild(this.overlay);
        }
        this.overlay = null;
      }, 300);
    }

    if (stopAudio && this.currentAudio) {
      this.currentAudio.pause();
      this.currentAudio.currentTime = 0;
      this.currentAudio = null;
    }
  }

  addStyles() {
    if (document.getElementById('dispense-notification-styles')) {
      return;
    }

    const style = document.createElement('style');
    style.id = 'dispense-notification-styles';
    style.textContent = `
      .dispense-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .dispense-notification.show {
        opacity: 1;
      }

      .dispense-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 40px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        text-align: center;
        min-width: 300px;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .dispense-icon {
        font-size: 48px;
        margin-bottom: 15px;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .dispense-message {
        font-size: 20px;
        font-weight: 600;
        line-height: 1.4;
      }
    `;

    document.head.appendChild(style);
  }

  dispenseMedicine(medicineName) {
    console.log('[MedicineDispenser] dispenseMedicine í˜¸ì¶œë¨, ì•½ ì´ë¦„:', medicineName);

    const medicineMap = {
      'í™•íœ': {
        message: 'í™•íœì´ ë‚˜ì˜¤ê³ ìˆìŠµë‹ˆë‹¤',
        audio: ['í™•íœì´ ë‚˜ì˜¤ê³ ìˆìŠµë‹ˆë‹¤.mp3', 'í¸ë‘í†µì´.mp3']
      },
      'ì²˜ë°©ì•½': {
        message: 'ì²˜ë°©ì•½ì´ ë°°ì¶œë˜ê³ ìˆìŠµë‹ˆë‹¤',
        audio: 'ì²˜ë°©ì•½ì´ ë°°ì¶œë˜ê³ ìˆìŠµë‹ˆë‹¤.mp3'
      },
      'í‚´ìŠ¤ì•½êµ­': {
        message: 'ì²˜ë°©ì•½ì´ ë°°ì¶œë˜ê³ ìˆìŠµë‹ˆë‹¤',
        audio: 'ì²˜ë°©ì•½ì´ ë°°ì¶œë˜ê³ ìˆìŠµë‹ˆë‹¤.mp3'
      }
    };

    const medicine = medicineMap[medicineName];
    if (medicine) {
      console.log('[MedicineDispenser] ì•½ ì •ë³´ ì°¾ìŒ:', medicine);
      this.showDispenseNotification(medicineName, medicine.message, medicine.audio);
    } else {
      console.warn('[MedicineDispenser] ì•Œ ìˆ˜ ì—†ëŠ” ì•½ ì´ë¦„:', medicineName);
    }
  }
}

// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
console.log('[MedicineDispenser] í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ, ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œì‘');
window.MedicineDispenser = new MedicineDispenser();
console.log('[MedicineDispenser] ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ, window.MedicineDispenser =', window.MedicineDispenser);

// ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
window.dispenseMedicine = function(medicineName) {
  window.MedicineDispenser.dispenseMedicine(medicineName);
};

// ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™” (í†µí•©) - Promise ë°˜í™˜
window.audioUnlocked = false;

window.unlockAudioContext = function() {
  return new Promise((resolve, reject) => {
    if (window.audioUnlocked) {
      console.log('[MedicineDispenser] ì´ë¯¸ unlockë¨');
      resolve();
      return;
    }

    console.log('[MedicineDispenser] ğŸµ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ unlock ì‹œë„');

    const silentAudio = new Audio();
    silentAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4T/hVmVAAAAAAD/+xBkAAP8AAAaQAAAAgAAA0gAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';

    const playPromise = silentAudio.play();

    if (playPromise !== undefined) {
      playPromise
        .then(() => {
          console.log('[MedicineDispenser] âœ… ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ unlock ì„±ê³µ!');
          silentAudio.pause();
          silentAudio.currentTime = 0;
          window.audioUnlocked = true;

          // ì‹œê°ì  í”¼ë“œë°±
          const body = document.body;
          const originalBg = body.style.backgroundColor;
          body.style.transition = 'background-color 0.3s';
          body.style.backgroundColor = '#e8f5e9';
          setTimeout(() => {
            body.style.backgroundColor = originalBg;
          }, 300);

          resolve();
        })
        .catch(err => {
          console.log('[MedicineDispenser] ì˜¤ë””ì˜¤ unlock ì‹¤íŒ¨:', err.name);
          reject(err);
        });
    } else {
      reject(new Error('playPromise undefined'));
    }
  });
};

// í˜ì´ì§€ì˜ ì²« í´ë¦­/í„°ì¹˜ì—ì„œ unlock
document.addEventListener('click', window.unlockAudioContext, { once: true });
document.addEventListener('touchstart', window.unlockAudioContext, { once: true });

console.log('[HOME INLINE] MedicineDispenser ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ');
</script>

<script src="{% static 'carepill/js/voice_navigation.js' %}?v=20251105-6"></script>
<script>
  // Voice Navigation Logic
  document.addEventListener('DOMContentLoaded', function() {
    // ì„¤ì • íƒ­ í´ë¦­ ì´ë²¤íŠ¸ (í† ê¸€)
    const settingsTab = document.getElementById('settingsTab');
    if (settingsTab) {
      settingsTab.addEventListener('click', async function() {
        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ unlock ì™„ë£Œ ëŒ€ê¸° (ì‚¬ìš©ì ì¸í„°ë™ì…˜)
        if (window.unlockAudioContext) {
          try {
            await window.unlockAudioContext();
            console.log('[ìŒì„±ì¸ì‹] unlock ì™„ë£Œ, ìŒì„±ì¸ì‹ í† ê¸€ ì‹œì‘');
          } catch (err) {
            console.error('[ìŒì„±ì¸ì‹] unlock ì‹¤íŒ¨:', err);
          }
        }
        toggleVoiceRecognition();
      });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹œì‘
    if (window.voiceNavigator) {
      // ìë™ ì‹œì‘ ì „ì— ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ unlock ì‹œë„
      if (window.unlockAudioContext) {
        window.unlockAudioContext();
      }

      window.voiceNavigator.autoStart(
        function(status, message) {
          console.log(`ìƒíƒœ: ${status}, ë©”ì‹œì§€: ${message}`);

          // ìŒì„± ì¸ì‹ì´ ì‹œì‘ë˜ë©´ ë‹¤ì‹œ í•œë²ˆ unlock ì‹œë„
          if (status === 'listening' && window.unlockAudioContext) {
            window.unlockAudioContext();
          }
        },
        function(command, url) {
          console.log(`ëª…ë ¹ì–´ ì¸ì‹: ${command} â†’ ${url}`);
        }
      );
    }

    // ìŒì„± ì¸ì‹ í† ê¸€ í•¨ìˆ˜ (UI ë³€í™” ì—†ìŒ)
    window.toggleVoiceRecognition = function() {
      if (!window.voiceNavigator) {
        console.error('ìŒì„± ì¸ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const isEnabled = window.voiceNavigator.toggle(
        function(status, message) {
          console.log(`ìƒíƒœ: ${status}, ë©”ì‹œì§€: ${message}`);
        },
        function(command, url) {
          console.log(`ëª…ë ¹ì–´ ì¸ì‹: ${command} â†’ ${url}`);
        }
      );

      console.log(isEnabled ? 'ìŒì„± ì¸ì‹ í™œì„±í™”ë¨' : 'ìŒì„± ì¸ì‹ ë¹„í™œì„±í™”ë¨');
    };

    // ìŒì„± ì¬ìƒ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    window.testAudioPlay = function() {
      console.log('[í…ŒìŠ¤íŠ¸] ìŒì„± ì¬ìƒ ì‹œì‘');

      const audioPath = '/static/carepill/audio/ì‹œì›Œë‚˜6ì‹œì•¼ì•½ì±™ê²¨ë¨¹ì–´ì•¼ì§€.mp3';
      const audio = new Audio(audioPath);

      audio.onloadeddata = () => {
        console.log('[í…ŒìŠ¤íŠ¸] ì˜¤ë””ì˜¤ íŒŒì¼ ë¡œë“œ ì™„ë£Œ');
      };

      audio.onplay = () => {
        console.log('[í…ŒìŠ¤íŠ¸] ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘ë¨');
      };

      audio.onended = () => {
        console.log('[í…ŒìŠ¤íŠ¸] ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ');
      };

      audio.onerror = (error) => {
        console.error('[í…ŒìŠ¤íŠ¸] ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', error);
      };

      audio.play()
        .then(() => {
          console.log('[í…ŒìŠ¤íŠ¸] âœ… ì˜¤ë””ì˜¤ ì¬ìƒ ì„±ê³µ!');
        })
        .catch(err => {
          console.error('[í…ŒìŠ¤íŠ¸] âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', err.name, err.message);
        });
    };
  });
</script>
<style>
  /* Voice Status Overlay Styles */
  .voice-status-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
  }

  .voice-status-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 24px;
    padding: 40px 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .voice-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s;
  }

  .voice-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .voice-status-icon {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .voice-pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    opacity: 0;
  }

  .voice-status-icon.listening .voice-pulse {
    animation: pulse 1.5s ease-out infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(0.8);
      opacity: 0.8;
    }
    100% {
      transform: scale(1.5);
      opacity: 0;
    }
  }

  .voice-mic-icon {
    font-size: 50px;
    z-index: 1;
  }

  .voice-status-icon.recognized .voice-mic-icon {
    animation: bounce 0.5s ease;
  }

  @keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  .voice-status-title {
    color: white;
    font-size: 24px;
    font-weight: bold;
    margin: 15px 0 10px;
  }

  .voice-status-message {
    color: rgba(255, 255, 255, 0.9);
    font-size: 16px;
    margin-bottom: 25px;
    min-height: 48px;
    white-space: pre-line;
  }

  .voice-commands-help {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 20px;
    text-align: left;
  }

  .voice-commands-help p {
    color: white;
    margin: 0 0 10px 0;
    font-size: 14px;
  }

  .voice-commands-help ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .voice-commands-help li {
    color: rgba(255, 255, 255, 0.9);
    font-size: 14px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .voice-commands-help li:last-child {
    border-bottom: none;
  }

  /* Mini tab hover effect */
  #settingsTab:hover {
    opacity: 0.7;
    text-decoration: underline;
  }
</style>
</body>
</html>
