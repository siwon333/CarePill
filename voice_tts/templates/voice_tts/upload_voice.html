<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì„± ìƒ˜í”Œ ì—…ë¡œë“œ - CarePill</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .upload-text {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

        .requirements {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .requirements h3 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .requirements ul {
            list-style: none;
            color: #856404;
        }

        .requirements li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .requirements li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .progress.show {
            display: block;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .links {
            margin-top: 30px;
            text-align: center;
        }

        .links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            font-size: 14px;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .current-voice {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .current-voice h3 {
            color: #0c5460;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .current-voice p {
            color: #0c5460;
            font-size: 14px;
            margin: 5px 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #f0f2ff;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .record-area {
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 20px;
        }

        .record-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 48px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: transform 0.2s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .record-button:hover {
            transform: scale(1.05);
        }

        .record-button:active {
            transform: scale(0.95);
        }

        .record-button.recording {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .record-status {
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .record-timer {
            color: #764ba2;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .record-hint {
            color: #999;
            font-size: 14px;
            margin-top: 10px;
        }

        .waveform {
            height: 60px;
            background: #f8f9ff;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 10px;
        }

        .waveform-bar {
            width: 4px;
            background: #667eea;
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .audio-preview {
            margin: 20px 0;
            display: none;
        }

        .audio-preview.show {
            display: block;
        }

        .audio-preview audio {
            width: 100%;
            margin: 10px 0;
        }

        .record-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .record-actions button {
            flex: 1;
        }

        .btn-secondary {
            background: #6c757d !important;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }

        .nav-menu {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-menu a {
            flex: 1;
            min-width: 140px;
            padding: 10px 15px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border: 2px solid #667eea;
            transition: all 0.3s ease;
        }

        .nav-menu a:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        .nav-menu a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .page-title h1 {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-menu">
            <a href="/api/tts/upload/" class="active">ìŒì„± ì—…ë¡œë“œ</a>
            <a href="/api/medicines/">ì•½ë¬¼ ê²€ìƒ‰</a>
            <a href="/ocr/">ì•½ ì‚¬ì§„ ì¸ì‹</a>
            <a href="/api/tts/health/">API ìƒíƒœ</a>
            <a href="/admin/">ê´€ë¦¬ì</a>
        </div>

        <div class="page-title">
            <h1>ìŒì„± ìƒ˜í”Œ ì—…ë¡œë“œ</h1>
        </div>
        <p class="subtitle">ë‚˜ë§Œì˜ ëª©ì†Œë¦¬ë¡œ TTSë¥¼ ìƒì„±í•˜ì„¸ìš”</p>

        {% if current_voice %}
        <div class="current-voice">
            <h3>í˜„ì¬ ë“±ë¡ëœ ìŒì„±</h3>
            <p><strong>íŒŒì¼:</strong> {{ current_voice.voice_file.name }}</p>
            <p><strong>ë“±ë¡ì¼:</strong> {{ current_voice.uploaded_at|date:"Y-m-d H:i" }}</p>
            <p><strong>ìƒíƒœ:</strong> {% if current_voice.is_active %}âœ… í™œì„±í™”{% else %}âŒ ë¹„í™œì„±í™”{% endif %}</p>
        </div>
        {% endif %}

        <div class="requirements">
            <h3>ğŸ“‹ ìŒì„± ìƒ˜í”Œ ìš”êµ¬ì‚¬í•­</h3>
            <ul>
                <li>ê¸¸ì´: 5~30ì´ˆ</li>
                <li>í¬ë§·: WAV, MP3, M4A, FLAC</li>
                <li>ë‚´ìš©: ëª…í™•í•˜ê²Œ ë§í•˜ê¸° (ì˜ˆ: "ì•ˆë…•í•˜ì„¸ìš”, ì €ëŠ” â—‹â—‹â—‹ì…ë‹ˆë‹¤")</li>
                <li>ë°°ê²½ ì†ŒìŒ ìµœì†Œí™”</li>
            </ul>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="record">ğŸ™ï¸ ì§ì ‘ ë…¹ìŒ</div>
            <div class="tab" data-tab="upload">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</div>
        </div>

        <div class="message" id="message"></div>
        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- ë…¹ìŒ íƒ­ -->
        <div class="tab-content active" id="recordTab">
            <div class="record-area">
                <button type="button" class="record-button" id="recordBtn">ğŸ¤</button>
                <div class="record-status" id="recordStatus">ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
                <div class="record-timer" id="recordTimer">00:00</div>
                <div class="record-hint">5~30ì´ˆ ì‚¬ì´ë¡œ ë…¹ìŒí•˜ì„¸ìš”</div>

                <div class="waveform" id="waveform">
                    <!-- ì›¨ì´ë¸Œí¼ ë°” 20ê°œ ìƒì„± -->
                </div>
            </div>

            <div class="audio-preview" id="audioPreview">
                <h4 style="color: #667eea; margin-bottom: 10px;">ë…¹ìŒëœ ìŒì„± ë¯¸ë¦¬ë“£ê¸°:</h4>
                <audio controls id="audioPlayer"></audio>

                <div class="record-actions">
                    <button type="button" class="btn-secondary" id="rerecordBtn">ğŸ”„ ë‹¤ì‹œ ë…¹ìŒ</button>
                    <button type="button" class="btn-success" id="saveRecordBtn">âœ… ì´ ë…¹ìŒ ì‚¬ìš©</button>
                </div>
            </div>
        </div>

        <!-- íŒŒì¼ ì—…ë¡œë“œ íƒ­ -->
        <div class="tab-content" id="uploadTab">
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ™ï¸</div>
                    <div class="upload-text">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                    <div class="upload-hint">WAV, MP3, M4A, FLAC (ìµœëŒ€ 10MB)</div>
                    <input type="file" name="voice_file" id="voiceFile" accept=".wav,.mp3,.m4a,.flac">
                </div>

                <div class="file-info" id="fileInfo">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>

                <button type="submit" id="submitBtn" disabled>ì—…ë¡œë“œ</button>
            </form>
        </div>
    </div>

    <script>
        // ============================================================================
        // ê³µí†µ ìš”ì†Œ
        // ============================================================================
        const message = document.getElementById('message');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');

        function showMessage(type, text) {
            message.className = 'message show ' + type;
            message.textContent = text;
        }

        function hideMessage() {
            message.className = 'message';
        }

        // ============================================================================
        // íƒ­ ì „í™˜
        // ============================================================================
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));

                // ì„ íƒí•œ íƒ­ í™œì„±í™”
                tab.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // ============================================================================
        // ë…¹ìŒ ê¸°ëŠ¥
        // ============================================================================
        let mediaRecorder;
        let audioChunks = [];
        let recordingTimer;
        let recordingSeconds = 0;
        let recordedBlob = null;

        const recordBtn = document.getElementById('recordBtn');
        const recordStatus = document.getElementById('recordStatus');
        const recordTimer = document.getElementById('recordTimer');
        const audioPreview = document.getElementById('audioPreview');
        const audioPlayer = document.getElementById('audioPlayer');
        const rerecordBtn = document.getElementById('rerecordBtn');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const waveform = document.getElementById('waveform');

        // ì›¨ì´ë¸Œí¼ ë°” ìƒì„±
        for (let i = 0; i < 20; i++) {
            const bar = document.createElement('div');
            bar.className = 'waveform-bar';
            bar.style.height = '10px';
            waveform.appendChild(bar);
        }

        recordBtn.addEventListener('click', toggleRecording);
        rerecordBtn.addEventListener('click', resetRecording);
        saveRecordBtn.addEventListener('click', uploadRecording);

        async function toggleRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingSeconds = 0;

                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    recordedBlob = audioBlob;
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPreview.classList.add('show');

                    // ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
                    stream.getTracks().forEach(track => track.stop());
                });

                mediaRecorder.start();
                recordBtn.classList.add('recording');
                recordBtn.textContent = 'â¹ï¸';
                recordStatus.textContent = 'ë…¹ìŒ ì¤‘... ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ì¤‘ì§€';
                recordStatus.style.color = '#ff6b6b';

                // íƒ€ì´ë¨¸ ì‹œì‘
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const mins = Math.floor(recordingSeconds / 60);
                    const secs = recordingSeconds % 60;
                    recordTimer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                    // ì›¨ì´ë¸Œí¼ ì• ë‹ˆë©”ì´ì…˜
                    const bars = waveform.querySelectorAll('.waveform-bar');
                    bars.forEach(bar => {
                        const height = Math.random() * 40 + 10;
                        bar.style.height = height + 'px';
                    });

                    // 30ì´ˆ ìë™ ì¢…ë£Œ
                    if (recordingSeconds >= 30) {
                        stopRecording();
                        showMessage('success', 'ìµœëŒ€ ë…¹ìŒ ì‹œê°„ 30ì´ˆì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
                    }
                }, 1000);

            } catch (error) {
                showMessage('error', 'ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingTimer);
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'ğŸ¤';
                recordStatus.textContent = 'ë…¹ìŒ ì™„ë£Œ! ë¯¸ë¦¬ë“£ê¸° í›„ ì €ì¥í•˜ì„¸ìš”';
                recordStatus.style.color = '#667eea';

                // ì›¨ì´ë¸Œí¼ ì´ˆê¸°í™”
                const bars = waveform.querySelectorAll('.waveform-bar');
                bars.forEach(bar => {
                    bar.style.height = '10px';
                });

                // 5ì´ˆ ë¯¸ë§Œ ê²½ê³ 
                if (recordingSeconds < 5) {
                    showMessage('error', 'âš ï¸ ë…¹ìŒì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìµœì†Œ 5ì´ˆ ì´ìƒ ë…¹ìŒí•˜ì„¸ìš”.');
                } else {
                    hideMessage();
                }
            }
        }

        function resetRecording() {
            audioPreview.classList.remove('show');
            recordTimer.textContent = '00:00';
            recordingSeconds = 0;
            recordedBlob = null;
            recordStatus.textContent = 'ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”';
            recordStatus.style.color = '#667eea';
            hideMessage();
        }

        async function uploadRecording() {
            if (!recordedBlob) {
                showMessage('error', 'ë…¹ìŒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (recordingSeconds < 5) {
                showMessage('error', 'ë…¹ìŒ ì‹œê°„ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìµœì†Œ 5ì´ˆ ì´ìƒ ë…¹ìŒí•˜ì„¸ìš”.');
                return;
            }

            // FormData ìƒì„±
            const formData = new FormData();
            const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
            formData.append('csrfmiddlewaretoken', csrf);
            formData.append('voice_file', recordedBlob, 'recorded_voice.wav');

            // ì—…ë¡œë“œ
            progress.classList.add('show');
            progressBar.style.width = '0%';

            try {
                let progressValue = 0;
                const progressInterval = setInterval(() => {
                    progressValue += 10;
                    if (progressValue <= 90) {
                        progressBar.style.width = progressValue + '%';
                    }
                }, 100);

                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (response.ok) {
                    showMessage('success', 'âœ… ìŒì„±ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    const data = await response.json();
                    showMessage('error', 'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                showMessage('error', 'âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }

            progress.classList.remove('show');
        }

        // ============================================================================
        // íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥
        // ============================================================================
        const uploadArea = document.getElementById('uploadArea');
        const voiceFile = document.getElementById('voiceFile');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const submitBtn = document.getElementById('submitBtn');
        const uploadForm = document.getElementById('uploadForm');

        // Click to upload
        uploadArea.addEventListener('click', () => {
            voiceFile.click();
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                voiceFile.files = files;
                handleFileSelect(files[0]);
            }
        });

        // File selection
        voiceFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            // Show file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');

            // Validate file
            const validTypes = ['audio/wav', 'audio/mpeg', 'audio/mp3', 'audio/mp4', 'audio/x-m4a', 'audio/flac'];
            const validExtensions = ['.wav', '.mp3', '.m4a', '.flac'];
            const ext = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));

            if (!validExtensions.includes(ext)) {
                showMessage('error', 'ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. WAV, MP3, M4A, FLACë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                submitBtn.disabled = true;
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showMessage('error', 'íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                submitBtn.disabled = true;
                return;
            }

            // Enable submit button
            submitBtn.disabled = false;
            hideMessage();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!voiceFile.files.length) {
                showMessage('error', 'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            // Show progress
            progress.classList.add('show');
            progressBar.style.width = '0%';
            submitBtn.disabled = true;

            const formData = new FormData(uploadForm);

            try {
                // Simulate progress
                let progressValue = 0;
                const progressInterval = setInterval(() => {
                    progressValue += 10;
                    if (progressValue <= 90) {
                        progressBar.style.width = progressValue + '%';
                    }
                }, 100);

                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (response.ok) {
                    showMessage('success', 'âœ… ìŒì„± ìƒ˜í”Œì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    const data = await response.json();
                    showMessage('error', 'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    submitBtn.disabled = false;
                }
            } catch (error) {
                showMessage('error', 'âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                submitBtn.disabled = false;
            }

            progress.classList.remove('show');
        });
    </script>
</body>
</html>
